# JVM

## JDK、JRE、JVM

JDK（Java Development Kit） 是用于开发 Java 应用程序的软件开发工具集合，包括了 Java 运行时的环境（JRE）、解释器（Java）、编译器（javac）、Java 归档（jar）、文档生成器（Javadoc）等工具。简单的说我们要开发Java程序，就需要安装某个版本的JDK工具包。

JRE（Java Runtime Enviroment ）提供 Java 应用程序执行时所需的环境，由 Java虚拟机（JVM）、核心类、支持文件等组成。简单的说，我们要是想在某个机器上运行Java程序，可以安装JDK，也可以只安装JRE，后者体积比较小。

Java Virtual Machine（Java 虚拟机）有三层含义，分别是：
- JVM规范要求
- 满足 JVM 规范要求的一种具体实现（一种计算机程序）
- 一个 JVM 运行实例，在命令提示符下编写 Java 命令以运行 Java 类时，都会创建一个 JVM 实例，我们下面如果只记到JVM则指的是这个含义；如果我们带上了某种JVM的名称，比如说是Zing JVM，则表示上面第二种含义

### 三者关系

就范围来说，JDK > JRE > JVM：
JDK = JRE + 开发工具
JRE = JVM + 类库

三者在开发运行Java程序时的交互关系：
简单的说，就是通过JDK开发的程序，编译以后，可以打包分发给其他装有JRE的机器上去运行
而运行的程序，则是通过java命令启动的一个JVM实例，代码逻辑的执行都运行在这个JVM实例上

Java程序的开发运行过程为：
我们利用 JDK （调用 Java API）开发Java程序，编译成字节码或者打包程序
然后可以用 JRE 则启动一个JVM实例，加载、验证、执行 Java 字节码以及依赖库，运行Java程序
而JVM 将程序和依赖库的Java字节码解析并变成本地代码执行，产生结果

## 常用性能指标

没有量化就没有改进

1. 分析系统性能问题： 比如是不是达到了我们预期性能指标，判断资源层面有没有问题，JVM层面有没有问题，系统的关键处理流程有没有问题，业务流程是否需要优化
2. 通过工具收集系统的状态，日志，包括打点做内部的指标收集，监控并得出关键性能指标数据，也包括进行压测，得到一些相关的压测数据和性能内部分析数据
3. 根据分析结果和性能指标，进行资源配置调整，并持续进行监控和分析，以优化性能，直到满足系统要求，达到系统的最佳性能状态

计算机系统中，性能相关的资源主要分为这几类:
- CPU：CPU是系统最关键的计算资源，在单位时间内有限，也是比较容易由于业务逻辑处理不合理而出现瓶颈的地方，浪费了CPU资源和过渡消耗CPU资源都不是理想状态，我们需要监控相关指标；
- 内存：内存则对应程序运行时直接可使用的数据快速暂存空间，也是有限的，使用过程随着时间的不断的申请内存又释放内存，好在JVM的GC帮我们处理了这些事情，但是如果GC配置的不合理，一样会在一定的时间后，产生包括OOM宕机之类的各种问题，所以内存指标也需要关注；
- IO（存储+网络）：CPU在内存中把业务逻辑计算以后，为了长期保存，就必须通过磁盘存储介质持久化，如果多机环境、分布式部署、对外提供网络服务能力，那么很多功能还需要直接使用网络，这两块的IO都会比CPU和内存速度更慢，所以也是我们关注的重点。

一般衡量系统性能的维度有3个:
- 延迟(Latency)： 一般衡量的是响应时间(Response Time)，比如平均响应时间。但是有时候响应时间抖动的特别厉害，也就是说有部分用户的响应时间特别高，这时我们一般假设我们要保障95%的用户在可接受的范围内响应，从而提供绝大多数用户具有良好的用户体验，这就是延迟的95线（P95，平均100个用户请求中95个已经响应的时间），同理还有99线，最大响应时间等（95线和99线比较常用；用户访问量大的时候，对网络有任何抖动都可能会导致最大响应时间变得非常大，最大响应时间这个指标不可控，一般不用）。
- 吞吐量(Throughput)： 一般对于交易类的系统我们使用每秒处理的事务数(TPS)来衡量吞吐能力，对于查询搜索类的系统我们也可以使用每秒处理的请求数（QPS）。
- 系统容量(Capacity)： 也叫做设计容量，可以理解为硬件配置，成本约束。

性能指标还可分为两类:
- 业务需求指标：如吞吐量(QPS、TPS)、响应时间(RT)、并发数、业务成功率等。
- 资源约束指标：如CPU、内存、I/O等资源的消耗情况。

我们可采用的手段和方式包括：
- 使用JDWP或开发工具做本地/远程调试
- 系统和JVM的状态监控，收集分析指标
- 性能分析: CPU使用情况/内存分配分析
- 内存分析: Dump分析/GC日志分析
- 调整JVM启动参数，GC策略等等

性能调优的第一步是制定指标，收集数据，第二步是找瓶颈，然后分析解决瓶颈问题。

脱离场景谈性能都是耍流氓
过早的优化是万恶之源

