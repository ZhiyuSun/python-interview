# 数据库调优

这部分出自Java金职业

业务需求
- 不合理的需求，可能造成很多问题
- 拨乱反正

系统架构
- 做架构设计的时候，应充分考虑业务的实际情况，考虑好数据库的各种选择
- 读写分离？高可用？实例个数？分库分表？用什么数据库？

SQL及索引
- 根据需求编写良好的SQL, 并去创建足够高效的索引

表结构
- 设计良好的表结构

数据库参数设置
- 设置合理的数据库性能参数

系统配置
- 操作系统提供了各种资源使用策略，设置合理的配置，以便于数据库充分利用资源

硬件
- 选用什么配置的机器？

## 测试数据准备与数据库操作工具

explain

## 索引

最左前缀原则

需要创建索引的场景
- select语句，频繁作为where条件的字段
- update/delete语句的where条件
- 需要分组、排序的字段
- distinct所使用的字段
- 字段的值有唯一性约束
- 对于多表查询，连接字段应创建索引

不建议创建索引的场景
- where子句里用不到的字段
- 表的记录非常少
- 有大量重复数据，选择性低
- 频繁更新的字段，如果创建索引要考虑其索引维护开销

### 索引失效和解决方案

- 索引字段不独立
    - 索引字段进行了表达式计算
    - 索引字段是函数的参数
- 使用了左模糊
- 使用or查询的部分字段没有索引（分别为两个字段创建索引）
- 字符串条件未使用''引起来（规范地编写SQL）
- 不符合最左前缀原则的查询
- 索引字段建议添加NOT NUll约束
    - 单列索引无法存储null值，复合索引无法存储全为null的值
    - 查询时，采用is null条件时，不能利用到索引，只能全表扫描
- 隐式转换导致索引失效

### 索引调优技巧

#### 长字段的调优技巧

- 引入hash字段，作为索引
- 使用前缀索引

#### 单列索引 VS 组合索引

- SQL存在多个条件，多个单列索引，会使用索引合并
- 如果出现索引合并，往往说明索引不够合理
- 如果SQL暂时没有性能问题，暂时可以不管
- 组合索引要注意索引列顺序【最左前缀原则】

#### 覆盖索引

尽量只返回想要的字段
- 使用覆盖索引
- 减少网络传输的开销

#### 重复索引、冗余索引、未使用的索引

重复索引
- 在相同的列上按照相同的顺序创建的索引
- 尽量避免重复索引，如果发现重复索引应该删除

冗余索引
- 如果已经存在索引index(A,B)，又创建了index(A)，那么index(A)就是index(A，B)的冗余索引

未使用的索引
- 某个索引根本未曾使用

#### JOIN优化

驱动表vs被驱动表
- 外层循环的表是驱动表，内层循环的表是被驱动表

Join调优原则
- 用小表驱动大表
    - 一般无需人工考虑，关联查询优化器会自动选择最优的执行顺序
    - 如果优化器抽风，可使用STRAIGHT_JOIN
- 如果有where条件，应当要能够使用索引，并尽可能地减少外层循环的数据量
- join的字段尽量创建索引
    - join字段的类型要保持一致
- 尽量减少扫描的行数（explain-rows）
    - 尽量控制在百万以内（经验之谈，仅供参考）
- 参与join的表不要太多
    - 阿里编程规约建议不超过3张
    - 不要以编写复杂SQL为荣，在业务代码里处理
- 如果被驱动表的join字段用不了索引，且内存较为充足，可以考虑把join buffer设置得大一些

#### limit优化

limit 300000, 10
rows 299999

方案1：覆盖索引
方案2：覆盖索引+join
方案3：覆盖索引+子查询
方案4：范围查询+limit语句
方案5：如果能获得起始主键值&结束主键值
方案6：禁止传入过大的页码

#### count优化

当没有非主键索引时，会使用主键索引
如果存在非主键索引的话，会使用非主键索引
如果存在多个非主键索引，会使用一个最小的非主键索引

count(*)和count(1)没有区别
count(*)不会排除为null的行，而count(字段)会排除

如果没有特殊需求，尽量用count(*)

- 创建一个更小的非主键索引
- 把数据库引擎换成MyISAM——实际项目用的很少，一般不会修改数据库引擎
- 汇总表 table[table_name, count]
    - 好处：结果比较准确
    - 缺点：增加了维护成本
- 缓存
    - 优点：性能比较高，结果比较准确，有误差但是比较小
    - 缺点：引入了额外的组件，增加了架构的复杂度

#### group by语句调优

### 表结构设计优化

第一范式：原子性
第二范式：互不依赖
第三范式：不存在传递依赖

表设计原则
- 字段少而精，建议20个以内，超过可以拆分
- 大字段独立出去
- 尽量用小型字段
- 避免使用允许为NULL的字段
- 合理平衡范式与冗余
- 如果数据量非常大，考虑分库分表

