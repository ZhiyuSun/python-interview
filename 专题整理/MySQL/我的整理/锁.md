# 锁

## MyISAM与Innodb关于锁方面的区别是什么

- MyISAM默认用的是表级锁，不支持行级锁
- Innodb默认用的是行级锁，也支持表级锁

myISAM里查询的时候，会对表加上表级的读锁

共享锁，排它锁。这一块好难，根本看不懂

## MyISAM的适合场景

- 频繁执行全表的count语句
- 对数据进行增删改查的频率不高，查询非常频繁
- 没有事务

## Innodb适合场景
- 数据增删改查都相当频繁。增删改都是某些行被锁，避免了阻塞。而不是MyISAM，每次增删改查都是锁整张表
- 可靠性要求比较高，要求支持事务

## 数据库锁的分类
- 按锁的粒度划分，可分为表级锁，行级锁，页级锁
- 按锁级别划分，可分为共享锁，排他锁
- 按加锁方式划分，可分为自动锁，显示锁
- 按操作划分，可分为DML锁（增删改查），DDL锁
- 按使用方式划分，可分为乐观锁，悲观锁（程序中也常见）

悲观锁：保守机制，先取锁再访问
乐观锁：提交时才对数据的冲突进行检测（版本号，时间戳）
- 先读取数据，得到的version值为versionValue
select version from test where id =2
- 每次更新表里的字段时，为了防止发生冲突，先去检查version再做更新，更新成功的话version+1
update test set money = 123,version = 0+1 where version=0 and id=2

## 乐观锁和悲观锁

- 悲观锁是先获取锁再进行操做。一锁二查三更新。select for update
- 乐观锁先修改，更新的时候发现数据已经变了就回滚。check and set
- 使需要根据响应速度、冲突频率、重试代价来判断使用哪一种

