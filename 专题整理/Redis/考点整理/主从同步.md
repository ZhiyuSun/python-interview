# 主从同步


## Redis的同步机制

主从同步原理

全同步过程
- Slave发送sync命令到Master
- Master启动一个后台进程，将Redis中的数据快照保存到文件中
- Master将保存数据快照期间接收到的写命令缓存起来
- Master完成写文件操作后，将该文件发送给Slave
- 使用新的AOF文件替换掉旧的AOF文件
- Master将这期间收集的增量写命令发送给Slave端

增量同步流程
- Master接收到用户的操作指令，判断是否需要传播到Slave
- 将操作记录追加到AOF文件
- 将操作传播到其他Slave：
    - 对齐主从库
    - 往响应缓存写入指令
- 将缓存中的数据发送给Slave

主从模式的弊端就是不具备高可用性
master挂掉之后，将不能提供写入操作，因此sentinel应运而生

## Redis Sentinel

解决主从同步Master宕机后的主从切换问题：
- 监控：检查主从服务器是否运行正常
- 提醒：通过API向管理员或者其他应用程序发送故障通知
- 自动故障迁移：主从切换

## 流言协议gossip

在杂乱无章中寻求一致
- 每个节点都随机地与对方通信，最终所有节点的状态达成一致
- 种子节点定期随机向其他节点发送节点列表以及需要传播的消息
- 不保证信息一定会传递给所有节点，但是最终会趋于一致

